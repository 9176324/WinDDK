<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:st1="urn:schemas-microsoft-com:office:smarttags"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="nscirda_files/filelist.xml">
<link rel=Edit-Time-Data href="nscirda_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>NSCIRDA - NDIS Fast Infrared Miniport</title>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="PlaceType"/>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="PlaceName"/>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="place"/>
<!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:TrackRevisions/>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]--><!--[if !mso]><object
 classid="clsid:38481807-CA0E-42D2-BF39-B33AF135CC4D" id=ieooui></object>
<style>
st1\:*{behavior:url(#ieooui) }
</style>
<![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Courier;
	panose-1:2 7 4 9 2 2 5 2 4 4;
	mso-font-charset:0;
	mso-generic-font-family:modern;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536871559 0 0 0 415 0;}
@font-face
	{font-family:"MS Sans Serif";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:"Times New Roman";
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:auto;
	mso-font-signature:0 0 0 0 0 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
p
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
pre
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";}
ins
	{mso-style-type:export-only;
	text-decoration:none;}
span.msoIns
	{mso-style-type:export-only;
	mso-style-name:"";
	text-decoration:underline;
	text-underline:single;}
span.msoDel
	{mso-style-type:export-only;
	mso-style-name:"";
	text-decoration:line-through;
	color:red;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 @list l0
	{mso-list-id:20473658;
	mso-list-template-ids:-561709968;}
@list l0:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l0:level2
	{mso-level-tab-stop:1.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level3
	{mso-level-tab-stop:1.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level4
	{mso-level-tab-stop:2.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level5
	{mso-level-tab-stop:2.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level6
	{mso-level-tab-stop:3.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level7
	{mso-level-tab-stop:3.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level8
	{mso-level-tab-stop:4.0in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l0:level9
	{mso-level-tab-stop:4.5in;
	mso-level-number-position:left;
	text-indent:-.25in;}
@list l1
	{mso-list-id:1840340934;
	mso-list-template-ids:-779612162;}
@list l1:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]-->
<meta name=Template content="C:\Program Files\Microsoft Office\Office\html.dot">
</head>

<body lang=EN-US link=blue vlink=purple style='tab-interval:.5in'>

<div class=Section1>

<h2><a name="_top"></a><span style='font-family:Verdana'>NSCIRDA – <st1:place
w:st="on"><st1:PlaceName w:st="on">NDIS</st1:PlaceName> <st1:PlaceName w:st="on">Fast</st1:PlaceName>
 <st1:PlaceName w:st="on">Infrared</st1:PlaceName> <st1:PlaceType w:st="on">Miniport</st1:PlaceType></st1:place><o:p></o:p></span></h2>

<h3><span style='font-family:Verdana'>SUMMARY<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>This is a sample NDIS
driver supporting the National Semiconductor Fast Infrared Controllers. It
implements the OID_IRDA_* calls required of any NDIS IrDA miniport.<o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>&nbsp;<o:p></o:p></span></h3>

<h3><span style='font-family:Verdana'>BUILDING THE SAMPLE<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>To build NSCIRDA.SYS,
select either the checked or free DDK environment, change to the directory
NSCIRDA, and type BUILD.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>This sample is included
as part of Windows 2000 for controlling the NSC FIR hardware included in laptop
and desktop computers. It supports plug-n-play, and will be installed
automatically on systems which have this hardware present and enabled. The
installation file, IRNSC.INF, is made for install from the CD and contains
differences from an INF file used for floppy installation.<o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>CODE TOUR<o:p></o:p></span></h3>

<h4><span style='font-family:Verdana'>File Manifest<o:p></o:p></span></h4>

<pre><o:p>&nbsp;</o:p></pre><pre><u>Files<span style='mso-spacerun:yes'>         </span>Description<o:p></o:p></u></pre><pre>NSCIRDA.HTM<span style='mso-spacerun:yes'>   </span>The Sample Tour documentation for this sample (this file).<o:p></o:p></pre><pre><span
class=GramE><span style='font-family:Courier'>SOURCES<span style='mso-spacerun:yes'>       </span>The generic file for building the code sample.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span
style='font-family:Courier'>NSC.C<span style='mso-spacerun:yes'>         </span>Providing NDIS entry points and the main logic of the driver.<o:p></o:p></span></pre><pre><span
class=GramE><span style='font-family:Courier'>NSC.H<span style='mso-spacerun:yes'>         </span>Header for NSC.C, providing main data structures.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span class=GramE><span
style='font-family:Courier'>NSCTYPES.H<span style='mso-spacerun:yes'>    </span>Some data types.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span
style='font-family:Courier'>COMM.C<span style='mso-spacerun:yes'>        </span>Supports the SIR mode of operation.<o:p></o:p></span></pre><pre><span
class=GramE><span style='font-family:Courier'>COMM.H<span style='mso-spacerun:yes'>        </span>Header for COMM.C.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span
style='font-family:Courier'>CONVERT.C<span style='mso-spacerun:yes'>     </span>Converts NDIS packets to SIR packets.<o:p></o:p></span></pre><pre><span
class=GramE><span style='font-family:Courier'>DONGLE.C<span style='mso-spacerun:yes'>      </span>Programming code for various FIR transceivers.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span class=GramE><span
style='font-family:Courier'>DONGLE.H<span style='mso-spacerun:yes'>      </span>Header for DONGLE.C.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span
style='font-family:Courier'>NEWDONG.H<span style='mso-spacerun:yes'>     </span>Another header for DONGLE.C.<o:p></o:p></span></pre><pre><span
class=GramE><span style='font-family:Courier'>FCS.C<span style='mso-spacerun:yes'>         </span>Source to generate SIR FCS (checksum) values.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span class=GramE><span
style='font-family:Courier'>INIT.C<span style='mso-spacerun:yes'>        </span>Source to initialize the controller.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span class=GramE><span
style='font-family:Courier'>NSCDEMO.H<span style='mso-spacerun:yes'>     </span>Prototypes for INIT.C.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span
style='font-family:Courier'>NSCFIR.C<span style='mso-spacerun:yes'>      </span>Supports the FIR mode of operation.<o:p></o:p></span></pre><pre><span
style='font-family:Courier'>REQUEST.C<span style='mso-spacerun:yes'>     </span>Implements the NDIS <span
class=SpellE>OIDs</span>.<o:p></o:p></span></pre><pre><span class=GramE><span
style='font-family:Courier'>RESOURCE.C<span style='mso-spacerun:yes'>    </span>Primitives to allocate and free memory and structures.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span class=GramE><span
style='font-family:Courier'>RESOURCE.H<span style='mso-spacerun:yes'>    </span>Header for RESOURCE.C.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span
style='font-family:Courier'>SETTINGS.C<span style='mso-spacerun:yes'>    </span>Table of IrDA speeds, and <span
class=GramE>debug</span> code.<o:p></o:p></span></pre><pre><span
style='font-family:Courier'>SETTINGS.H<span style='mso-spacerun:yes'>    </span>Header for SETTINGS.C, many debug defines.<o:p></o:p></span></pre><pre><span
style='font-family:Courier'>SYNC.C<span style='mso-spacerun:yes'>        </span>Provides ISR Synchronized List functions.<o:p></o:p></span></pre><pre><span
class=GramE><span style='font-family:Courier'>SYNC.H<span style='mso-spacerun:yes'>        </span>Header for SYNC.C.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span
style='font-family:Courier'>DEFS.H<span style='mso-spacerun:yes'>        </span>Included by NEWDONG.H.<o:p></o:p></span></pre><pre><span
class=GramE><span style='font-family:Courier'>EXTERNS.H<span style='mso-spacerun:yes'>     </span>Prototypes.</span></span><span
style='font-family:Courier'><o:p></o:p></span></pre><pre><span
style='font-family:Courier'>IRNSC.INF<span style='mso-spacerun:yes'>     </span>Installation File<o:p></o:p></span></pre>

<h4 style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'>Programming
Tour<o:p></o:p></h4>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>As this is an NDIS miniport, the
documentation of NDIS features is left to other sections. This code tour
focuses on IrDA under NDIS, and features unique to this miniport. The
OID_IRDA_* calls are described in a .DOC file included with the IrDA samples.<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>The major topics covered in this
tour are: <o:p></o:p></span></p>

<p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
margin-left:.5in;text-indent:-.5in;mso-text-indent-alt:-.25in;mso-list:l0 level1 lfo3;
mso-list-change:\F0B7 "john osborne" 20040923T1745;tab-stops:list .5in'><![if !supportLists]><span
style='font-size:10.0pt;font-family:Symbol;mso-fareast-font-family:Symbol;
mso-bidi-font-family:Symbol'><span style='mso-list:Ignore'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>Management
of DMA buffers <o:p></o:p></span></p>

<p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
margin-left:.5in;text-indent:-.5in;mso-text-indent-alt:-.25in;mso-list:l0 level1 lfo3;
mso-list-change:\F0B7 "john osborne" 20040923T1745;tab-stops:list .5in'><![if !supportLists]><span
style='font-size:10.0pt;font-family:Symbol;mso-fareast-font-family:Symbol;
mso-bidi-font-family:Symbol'><span style='mso-list:Ignore'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>ISR
accessible linked lists <o:p></o:p></span></p>

<p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
margin-left:.5in;text-indent:-.5in;mso-text-indent-alt:-.25in;mso-list:l0 level1 lfo3;
mso-list-change:\F0B7 "john osborne" 20040923T1745;tab-stops:list .5in'><![if !supportLists]><span
style='font-size:10.0pt;font-family:Symbol;mso-fareast-font-family:Symbol;
mso-bidi-font-family:Symbol'><span style='mso-list:Ignore'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>Turnaround
Delays<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><b><span
style='font-size:10.0pt;font-family:Verdana'>Management of DMA buffers<o:p></o:p></span></b></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>In FIR mode, most IrDA controllers
use DMA to receive IrDA packets. These packets can range from 2 to 2048 bytes
in size, and can be located at any offset inside the DMA buffer. Since the DMA
buffer is usually never filled by packets, and there is no way to know exactly
how many packets will be received, special efforts must be made to know when to
stop the DMA transfer. In NSCIRDA, this is accomplished via a repeating
timeout. Once data begins to be received (indicated by an interrupt), NSCIRDA
programs the controller to produce an interrupt every few milliseconds. In the
interrupt’s DPC routine, it calls <span class=SpellE><i>NdisMReadDmaCounter</i></span>
to determine if data is still flowing. When the counter stops changing, it
stops the DMA and begins to extract the packets. Since more packets may be
coming, it is important to restart the DMA as quickly as possible.<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>NDIS requires that packets
indicated to the protocol can be kept indefinitely or returned in any order.
These requirements would seem to imply that data in the DMA buffer should be
copied out to an NDIS buffer before being indicated to the protocol, but this
introduces two problems. First, a second set of buffers must be used to hold
the copied packets, increasing the memory footprint of the driver. Second is
the overhead of the copy itself. Since most IrDA devices are presently found in
laptop and notebook computers, both of these concerns are more significant as
memory and computing power are usually lower in these systems than their
desktop counterparts.<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>NSCIRDA avoids both problems by
implementing a mechanism whereby the memory used to DMA the packet is the same
memory used to indicate the packet, and yet a new DMA can be started
immediately to capture more packets.<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>The heart of this mechanism is a
pair of linked lists, <span class=SpellE><i>rcvBufFull</i></span> and <span
class=SpellE><i>rcvBufPend</i></span>, <span class=SpellE>containg</span> <span
class=SpellE><i>rcvBuffer</i></span> structures. Once a DMA is completed, <span
class=SpellE><i>FIR_DeliverFrames</i></span> walks the buffer, identifying
packets and verifying their integrity. <b>It is the responsibility of the
miniport that no corrupt packets be indicated to the protocol.</b> Once a valid
packet has been identified, <span class=SpellE><i>QueueReceivePackets</i></span>
is called to associate the data in the DMA area with <span class=GramE>a</span>
<span class=SpellE><i>rcvBuffer</i></span> header, and the header is placed on
the end of the <span class=SpellE><i>rcvBufFull</i></span> list.<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><img
width=586 height=251 id="_x0000_i1025" src=FIRrecv1.gif><o:p></o:p></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>After all packets have been
identified in this way, <span class=SpellE><i>FindLargestSpace</i></span> is
called to locate the largest unused portion of the DMA buffer, and a new DMA is
started in that space only. In most cases, the <span class=SpellE><i>rcvBufPend</i></span>
list will be empty, and the area identified by <span class=SpellE><i>FindLargestSpace</i></span>
will begin at the end of the last packet and reach to the end of the DMA area,
as in Figure 1. After the DMA is restarted, the miniport may proceed to
indicate the new packets to the protocol. As each packet is indicated, its <span
class=SpellE><i>rcvBuffer</i></span> header is moved from <span class=SpellE><i>rcvBufFull</i></span>
to <span class=SpellE><i>rcvBufPend</i></span>.<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>In the case of packet loss and
retransmission, packets may be held by the protocol for some time, even across
several transmissions and link turnarounds.<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><img
width=586 height=250 id="_x0000_i1026" src=FIRrecv2.gif><o:p></o:p></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>In Figure 2, we see that two
packets have been indicated to the protocol and not returned, one new packet
has been received, and there are now three non-contiguous areas of unused space
in the DMA buffer. <span class=SpellE><i>FindLargestSpace</i></span> will walk
both lists simultaneously to find the unused area, and in the example would
identify the middle space for a new DMA transfer. <span class=SpellE><i>FindLargestSpace</i></span>
requires that the data indicated by <span class=SpellE><i>rcvBufFull</i></span>
and <span class=SpellE><i>rcvBufPend</i></span> be ordered by address, highest
address last.<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><b><span
style='font-size:10.0pt;font-family:Verdana'>ISR Accessible linked lists<o:p></o:p></span></b></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>All packet handling in NSCIRDA is
accomplished via linked lists. In the case of SIR mode, it may be required that
the lists be accessed inside of an ISR. <i>SYNC.C</i> and <i>SYNC.H</i> provide
equivalents to the standard <span class=SpellE><i>NdisInterlocked</i></span><i>*List</i>
functions that are protected by <span class=SpellE><i>SyncWithInterrupt</i></span>
instead of <span class=SpellE>spinlocks</span>. It is important that you
understand how this works, and which mechanism is used for a specific list.<o:p></o:p></span></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><b><span
style='font-size:10.0pt;font-family:Verdana'>Turnaround delays<o:p></o:p></span></b></p>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:Verdana'>The half-duplex nature of infrared
devices requires a turnaround delay, a delay that occurs before the first
packet in a series of transmissions, to insure that the other side is prepared
to receive data. Most previous implementations of this delay have used <span
class=SpellE><i>NdisStallExecution</i></span>. It should be remembered that <span
class=SpellE><i>NdisStallExecution</i></span> is for delays of <i>no more than
50 microseconds</i>. During <span class=SpellE><i>NdisStallExecution</i></span>,
the processor can only idle. Using it to implement the turnaround delay that
can last several milliseconds can have a significant impact on system
performance. NSCIRDA uses <span class=SpellE>NdisTimer</span> to accomplish the
delay.<o:p></o:p></span></p>

<p align=center style='text-align:center;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:"Courier New"'><a href="#top"><span
style='font-family:Verdana'>Top of page</span></a></span><span
style='font-size:10.0pt;font-family:Verdana;mso-bidi-font-family:"Courier New"'>
<o:p></o:p></span></p>

<pre><o:p>&nbsp;</o:p></pre>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=624
 style='width:6.5in;mso-cellspacing:0in;mso-padding-alt:0in 5.4pt 0in 5.4pt'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes;
  height:1.5pt'>
  <td style='background:aqua;padding:.75pt .75pt .75pt .75pt;height:1.5pt'>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
</table>

<pre><o:p>&nbsp;</o:p></pre><pre><o:p>&nbsp;</o:p></pre>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:7.5pt;font-family:"MS Sans Serif";mso-bidi-font-family:"Courier New"'>©
2004 Microsoft Corporation</span><span style='font-size:10.0pt;font-family:
Verdana;mso-bidi-font-family:"Courier New"'> <o:p></o:p></span></p>

</div>

</body>

</html>

