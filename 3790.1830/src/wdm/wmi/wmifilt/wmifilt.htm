<html xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=us-ascii">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="wmifilt_files/filelist.xml">
<title>WMIFilt</title>
<!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>BestFit</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536871559 0 0 0 415 0;}
@font-face
	{font-family:"MS Sans Serif";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:"Times New Roman";
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:auto;
	mso-font-signature:0 0 0 0 0 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
h2
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:2;
	font-size:18.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h3
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:3;
	font-size:13.5pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h4
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:4;
	font-size:12.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
p
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
pre
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 @list l0
	{mso-list-id:1805460694;
	mso-list-type:hybrid;
	mso-list-template-ids:-1723428770 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l0:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;
	font-family:Symbol;}
ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<h2><span class=SpellE><span style='font-family:Verdana'>WMIFilt</span></span><span
style='font-family:Verdana'><o:p></o:p></span></h2>

<h3><span style='font-family:Verdana'>SUMMARY<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>This is a sample Plug and
Play filter driver that provides WMI data blocks. Typically, driver writers copy
the sample code into their own driver and make any minor modifications so that
the WMI data blocks are always available when the driver is loaded.
Alternatively, <span class=SpellE>WmiSamp</span> can be left as a filter driver
if WMI data blocks should only be made available when the filter driver is
loaded.<o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>BUILDING THE SAMPLE<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>Follow these steps to
WMI-enable a driver with the sample code.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>1. Determine what data
needs to be provided and organize it into data blocks that contain related data
items. For example, packets sent and bytes sent could be part of a single data
block, while transmit errors could be part of a data block that contains other
error counts. Determine if the device needs notification when to enable and
disable collections in the case of data blocks that impose a performance hit to
collect.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>2. Write one or more
Managed Object Format (.<span class=SpellE>mof</span>) files that describe the
data blocks. In doing this, the driver writer will need to run the <span
class=SpellE>GUIDgen</span> tool to create globally unique <span class=SpellE>GUIDs</span>
that are assigned to the data blocks. <span class=SpellE>GUIDgen</span> <i>must</i>
be run so that no two data block formats have the same GUID. Compile the .<span
class=SpellE>mof</span> files into .<span class=SpellE>bmf</span> files by
using the <span class=SpellE>Mofcomp</span> tool. The resulting .<span
class=SpellE>bmf</span> files are platform-independent binaries, and can be
reported as resources attached to the .sys file or as one or more instances of
a data block queried by WMI. The former mechanism is useful for drivers with a
static .<span class=SpellE>mof</span> and the latter for drivers with a dynamic
.<span class=SpellE>mof</span>. For .<span class=SpellE>mof</span> data
reported via a resource attached to the .sys file, reference the .<span
class=SpellE>bmf</span> file in the driver's .<span class=SpellE>rc</span> file
so that the .<span class=SpellE>bmf</span> file data is included as a resource
of the driver's .sys file. For .<span class=SpellE>mof</span> data reported as
instances of a data block, the .x files are included into the source of the
driver as a global data buffer. Note that .x files are created by wmimofck.exe
and are the ASCII representation of the .<span class=SpellE>bmf</span> file. It
is possible that a driver reporting via the data block query mechanism could
have many instances of the binary .<span class=SpellE>mof</span> data block and
only report those that are appropriate depending upon the state of the device.
See the USE_BINARY_MOF_QUERY definition for more information. Also note that
one of the byproducts of generating the binary .<span class=SpellE>mof</span>
file is a header file that contains GUID and structure definitions for the data
blocks. Use this header because it will always be up to date with the .<span
class=SpellE>mof</span>. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>3. Build the
WMIGUIDREGINFO structure with the <span class=SpellE>GUIDs</span> for the data
blocks defined in the .<span class=SpellE>mof</span> file. If the device should
be notified when to start and stop collection of a data block, the
WMIREG_FLAG_EXPENSIVE flag should be set for the data block in the
WMIGUIDREGINFO structure.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>4. Implement the six WMI
function callback routines and reference them in a WMILIB_CONTEXT structure.
Note that some of them are optional.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>5. Modify the sources and
<span class=SpellE>makefile.inc</span> files so that the .<span class=SpellE>mof</span>
file is compiled into the .<span class=SpellE>bmf</span>, .x, .<span
class=SpellE>vbs</span> and .h file. Also check that USE_BINARY_MOF_QUERY is
defined appropriately for the method of reporting MOF data. <o:p></o:p></span></p>

<p><b><span style='font-size:10.0pt;font-family:Verdana'>Note</span></b><span
style='font-size:10.0pt;font-family:Verdana'>: Another byproduct of compiling
the .<span class=SpellE>mof</span> is a .<span class=SpellE>vbs</span> file.
This is a VBScript file that is run from the command line on the target machine
running the new device driver. It will cause WMI to query all data blocks and
properties, and put the results into a .log file. This can be very useful for
testing WMI support in your driver. For more sophisticated testing, the VBScript
can be extended by hand. The <span class=SpellE>WBEMTest</span> tool (located
in %windir%\system32\wbem\) can also be used. <o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>RESOURCES<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>Please see the
Kernel-Mode driver section of DDK documentation for more information on WMI. <o:p></o:p></span></p>

<p><b><span style='font-size:10.0pt;font-family:Verdana'>WMI <span
class=SpellE>Mof</span> Check Tool</span></b><span style='font-size:10.0pt;
font-family:Verdana'><o:p></o:p></span></p>

<p><span class=SpellE><span style='font-size:10.0pt;font-family:Verdana'>WmiMofCk</span></span><span
style='font-size:10.0pt;font-family:Verdana'> validates that the classes,
properties, methods and events specified in a binary <span class=SpellE>mof</span>
file (.<span class=SpellE>bmf</span>) are valid for use with WMI. It also
generates useful output files needed to build and test the WMI data provider.<o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l0 level1 lfo1;
tab-stops:list .5in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Symbol;mso-fareast-font-family:Symbol;mso-bidi-font-family:Symbol'><span
style='mso-list:Ignore'>&middot;<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>If
the -h parameter is specified, a C language header file is created that defines
the <span class=SpellE>GUIDs</span>, data structures, and method indices
specified in the MOF file.<o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l0 level1 lfo1;
tab-stops:list .5in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Symbol;mso-fareast-font-family:Symbol;mso-bidi-font-family:Symbol'><span
style='mso-list:Ignore'>&middot;<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>If
the -t parameter is specified, a VBScript applet is created that will query all
data blocks and properties specified in the .<span class=SpellE>mof</span>
file. This can be useful for testing WMI data providers.<o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l0 level1 lfo1;
tab-stops:list .5in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Symbol;mso-fareast-font-family:Symbol;mso-bidi-font-family:Symbol'><span
style='mso-list:Ignore'>&middot;<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana'>If
the -x parameter is specified, a text file is created that contains the text
representation of the binary .<span class=SpellE>mof</span> data. This can be
included in the source of the driver if the driver supports reporting the
binary .<span class=SpellE>mof</span> via a WMI query rather than a resource on
the driver image file.<o:p></o:p></span></p>

<p style='margin-left:.5in;text-indent:-.25in;mso-list:l0 level1 lfo1;
tab-stops:list .5in'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Symbol;mso-fareast-font-family:Symbol;mso-bidi-font-family:Symbol'><span
style='mso-list:Ignore'>&middot;<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><![endif]><span style='font-size:10.0pt;font-family:Verdana;
mso-bidi-font-weight:bold'>Usage</span><span style='font-size:10.0pt;
font-family:Verdana'>: <span class=SpellE>wmimofck</span> -h&lt;C Header output
file&gt; -x&lt;<span class=SpellE>Hexdump</span> output file&gt; -t&lt;VBScript
test output file&gt; &lt;binary <span class=SpellE>mof</span> input file&gt;<o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>CODE TOUR<o:p></o:p></span></h3>

<h4><span style='font-family:Verdana'>File Manifest<o:p></o:p></span></h4>

<pre><u>File<span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Description<o:p></o:p></u></pre><pre><o:p>&nbsp;</o:p></pre><pre><span
class=SpellE>Filter.c</span><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>NULL filter driver (boilerplate code)</pre><pre><span
class=SpellE>Filter.h</span><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Header <span
class=GramE>file</span> for the filter driver</pre><pre><span class=SpellE>Filter.mof</span> <span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span>Managed Object Format file that contains descriptions of the data blocks events and methods implemented by the driver</pre><pre><span
class=SpellE>Filter.rc</span><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Resource <span
class=GramE>file</span> containing version information</pre><pre>Inf.txt<span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sections of the .<span
class=SpellE>inf</span> file to change</pre><pre><span class=SpellE>Makefile</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Standard Windows NT <span
class=SpellE>makefile</span></pre><pre><span class=SpellE>Pnp.c</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Plug and Play routines</pre><pre><span
class=SpellE>Power.c</span><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Power Management routines</pre><pre>Sources<span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sources for build</pre><pre><span
class=SpellE>Util.c</span><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>NULL filter driver&#8212;boilerplate code</pre><pre><span
class=SpellE>Wmisamp.c</span><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sample device driver that shows various mechanisms for using WMI in a kernel-mode driver<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span></pre>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:"Courier New"'><o:p>&nbsp;</o:p></span></p>

<p align=center style='text-align:center;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:"Courier New"'><a href="#top"><span
style='font-family:Verdana'>Top of page</span></a></span><span
style='font-size:10.0pt;font-family:Verdana;mso-bidi-font-family:"Courier New"'>
<o:p></o:p></span></p>

<pre><o:p>&nbsp;</o:p></pre>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=624
 style='width:6.5in;mso-cellspacing:0in'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes;
  height:1.5pt'>
  <td style='background:aqua;padding:.75pt .75pt .75pt .75pt;height:1.5pt'>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
</table>

<pre><o:p>&nbsp;</o:p></pre><pre><o:p>&nbsp;</o:p></pre>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:7.5pt;font-family:"MS Sans Serif";mso-bidi-font-family:"Courier New"'>&copy;
2004 Microsoft Corporation</span><span style='font-size:10.0pt;font-family:
Verdana;mso-bidi-font-family:"Courier New"'> <o:p></o:p></span></p>

</div>

</body>

</html>

