<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="avssamp_files/filelist.xml">
<title>Avssamp</title>
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536871559 0 0 0 415 0;}
@font-face
	{font-family:"MS Sans Serif";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:"Times New Roman";
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:auto;
	mso-font-signature:0 0 0 0 0 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
h2
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:2;
	font-size:18.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h3
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:3;
	font-size:13.5pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h4
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:4;
	font-size:12.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
p
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
pre
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<h2><span class=SpellE><span style='font-family:Verdana'>Avssamp</span></span><span
style='font-family:Verdana'>: Sample Filter-Centric <span class=SpellE>AVStream</span>
Simulated Capture Driver <o:p></o:p></span></h2>

<h3><span style='font-family:Verdana'>SUMMARY<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>The <span class=SpellE>Avssamp</span>
sample provides a filter-centric <span class=SpellE>AVStream</span> capture
driver with functional audio. The driver performs captures at 320x240 in either
an RGB24 or YUV422 format while playing a user-provided PCM wave audio file in
a loop. The purpose of the sample is to demonstrate how to write a
filter-centric <span class=SpellE>AVStream</span> <span class=SpellE>minidriver</span>.
This sample was significantly redesigned for the Microsoft® Windows Server
2003® DDK. <o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>BUILDING THE SAMPLE<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>Build the sample by
typing <b>build -<span class=SpellE><span class=GramE>zc</span></span></b> in
either the standard checked or free build environment. A successful build
produces <span class=SpellE><i>avssamp.sys</i></span><i>.</i> To install the
driver, right click on <span class=SpellE><i>avssamp.inf</i></span> and select
Install. When prompted for <span class=SpellE><i>avssamp.sys</i></span>, select
the built binary.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>The sample works on x86
platforms and builds correctly using Microsoft® Visual C® 6.0. The driver uses
Plug and Play. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>This sample runs on
Microsoft® Windows XP®, and Windows Server 2003® or any platform Windows 98®
gold or beyond, including Windows 2000<span class=GramE>®, that</span> has
DirectX 8.0 or beyond installed.<o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>PROGRAMMING TOUR<o:p></o:p></span></h3>

<p><span class=SpellE><b><span style='font-size:10.0pt;font-family:Verdana'>DriverEntry</span></b></span><span
style='font-size:10.0pt;font-family:Verdana'> in <span class=SpellE><i>avssamp.cpp</i></span>
is the initial point of entry. This routine passes control to <span
class=SpellE>AVStream</span> through a call to <span class=SpellE><b>KsInitializeDriver</b></span>.
In this call, the <span class=SpellE>minidriver</span> passes the device
descriptor, an <span class=SpellE>AVStream</span> structure that recursively
defines the <span class=SpellE>AVStream</span> object hierarchy for a driver.
This is common behavior for an <span class=SpellE>AVStream</span> <span
class=SpellE>minidriver</span>. <o:p></o:p></span></p>

<p><span class=SpellE><i><span style='font-size:10.0pt;font-family:Verdana'>Filter.cpp</span></i></span><span
style='font-size:10.0pt;font-family:Verdana'> is where the sample lays out the
KSPIN_DESCRIPTOR_EX structure for the single video pin. <span class=SpellE><i>Audio.cpp</i></span>
contains the KSPIN_DESCRIPTOR_EX structure for the audio capture pin. This pin
is dynamically created only if <i>c:\avssamp.wav</i> exists and is a valid and
readable PCM format wave file. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>The filter dispatch
structure in <span class=SpellE><i>filter.cpp</i></span> provides dispatches to
create and process. The <span class=SpellE><b>DispatchProcess</b></span> method
is defined inline in <span class=SpellE><i>filter.h</i></span>. It calls the <b>Process</b>
method in <span class=SpellE><i>filter.cpp</i></span> in the context of the <span
class=SpellE>CCaptureFilter</span>. Note that the process dispatch is provided
in KSFILTER_DISPATCH since this sample is filter-centric.<o:p></o:p></span></p>

<p><span class=SpellE><i><span style='font-size:10.0pt;font-family:Verdana'>Audio.cpp</span></i></span><span
style='font-size:10.0pt;font-family:Verdana'> lays out a KSPIN_DISPATCH
structure which contains the dispatch table for the audio pin. Note that the
Process member of this structure is NULL since the sample is filter-centric.
Similarly, <span class=SpellE><i>video.cpp</i></span> contains the pin dispatch
structure for the video capture pin, again with the Process member set to NULL.
<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>See comments in all .<span
class=SpellE>cpp</span> files. Also see complete <span class=SpellE>AVStream</span>
documentation in the DDK documentation. <o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>RUNNING THE SAMPLE<o:p></o:p></span></h3>

<p><span class=GramE><span style='font-size:10.0pt;font-family:Verdana'>Once
installation is complete, access the driver using the <span class=SpellE>Graphedt</span>
tool.</span></span><span style='font-size:10.0pt;font-family:Verdana'> <i>Graphedt.exe</i>
is available under the <i>Tools\<span class=SpellE>AVStream</span></i>
directory of the DDK. In the <span class=SpellE>Graphedt</span> application,
click the Graph menu and select Insert Filters. The sample appears under
&quot;WDM Streaming Capture Devices&quot; as &quot;<span class=SpellE>avssamp</span>
Source.&quot; Click Insert Filter and the sample <span class=GramE>appears</span>
in the graph as a single filter <span class=SpellE>labelled</span> as <span
class=SpellE>avssamp</span> Source. Attach this filter to either a DirectShow
Video <span class=SpellE>Renderer</span> or the VMR default video <span
class=SpellE>renderer</span> and click Play. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>To play audio, before
inserting the <span class=SpellE>avssamp</span> filter, make sure that a valid
PCM wave file exists at <i>c:\avssamp.wav</i>. Then insert the <span
class=SpellE>avssamp</span> filter. If a valid file exists at this location,
the <span class=SpellE>avssamp</span> filter will appear with an audio capture
pin. Connect the video pin to the DirectShow Smart Tee filter and connect the
Tee's preview pin as described for video above (note that this is only
necessary for synchronized preview -- not capture). Attach the audio pin to a
Default <span class=SpellE>Waveout</span> Device filter from the Audio <span
class=SpellE>Renderer</span> list. Click play. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>The output produced by
the sample is a 320x240 image of standard EIA-189-A color bars. <o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>COMMENTS<o:p></o:p></span></h3>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Verdana'>For more
information on <span class=SpellE>AVStream</span>, see the DDK documentation. <o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>CODE TOUR<o:p></o:p></span></h3>

<h4><span style='font-family:Verdana'>File Manifest<o:p></o:p></span></h4>

<pre><u>File</u><span style='mso-tab-count:2'>           </span><u>Description<o:p></o:p></u></pre><pre><o:p>&nbsp;</o:p></pre><pre><span
class=SpellE><span class=GramE>audio.cpp</span></span><span style='mso-tab-count:
1'>      </span>Audio capture pin implementation.</pre><pre><span class=SpellE><span
class=GramE>audio.h</span></span><span style='mso-tab-count:2'>        </span>Audio capture pin header.</pre><pre><span
class=SpellE><span class=GramE>avssamp.cpp</span></span><span style='mso-tab-count:
1'>    </span>The main file for the filter-centric sample.</pre><pre><span
class=SpellE><span class=GramE>avssamp.h</span></span><span style='mso-tab-count:
1'>      </span>The main header file for the sample.</pre><pre><span
class=GramE>avssamp.htm</span><span style='mso-tab-count:1'>    </span>The Sample Tour documentation for this sample (this file).</pre><pre><span
class=SpellE><span class=GramE>avssamp.inf</span></span><span style='mso-tab-count:
1'>    </span>A sample installation file.</pre><pre><span class=SpellE><span
class=GramE>avssamp.rc</span></span><span style='mso-tab-count:1'>     </span>Resource file mainly for version.</pre><pre><span
class=SpellE><span class=GramE>capture.cpp</span></span><span style='mso-tab-count:
1'>    </span>The capture pin implementation for all capture pins on the sample filter.</pre><pre><span
class=SpellE><span class=GramE>capture.h</span></span><span style='mso-tab-count:
1'>      </span>The capture pin header for all capture pins on the sample filter.</pre><pre><span
class=SpellE><span class=GramE>filter.cpp</span></span><span style='mso-tab-count:
1'>     </span>The capture filter implementation (including frame synthesis) for the fake capture filter.</pre><pre><span
class=SpellE><span class=GramE>filter.h</span></span><span style='mso-tab-count:
1'>       </span>Header for the capture filter implementation for the fake capture filter.</pre><pre><span
class=SpellE><span class=GramE>image.cpp</span></span><span style='mso-tab-count:
1'>      </span>Image synthesis and overlay code. See comments in file.</pre><pre><span
class=SpellE><span class=GramE>image.h</span></span><span style='mso-tab-count:
2'>        </span>Image synthesis and overlay header.</pre><pre><span
class=GramE>Sources<span style='mso-tab-count:2'>        </span>The generic file for building the code sample.</span></pre><pre><span
class=SpellE><span class=GramE>video.cpp</span></span><span style='mso-tab-count:
1'>      </span>Video capture pin implementation.</pre><pre><span class=SpellE><span
class=GramE>video.h</span></span><span style='mso-tab-count:2'>        </span>Video capture pin header.</pre><pre><span
class=SpellE><span class=GramE>wave.cpp</span></span><span style='mso-tab-count:
1'>       </span>Wave object implementation.</pre><pre><span class=SpellE><span
class=GramE>wave.h</span></span><span style='mso-tab-count:2'>         </span>Wave object header.</pre><pre><o:p>&nbsp;</o:p></pre><pre><o:p>&nbsp;</o:p></pre>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=624
 style='width:6.5in;mso-cellspacing:0in'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes;
  height:1.5pt'>
  <td style='background:aqua;padding:.75pt .75pt .75pt .75pt;height:1.5pt'>
  <p class=MsoNormal><span style='font-size:2.0pt;mso-bidi-font-size:12.0pt'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<pre><o:p>&nbsp;</o:p></pre><pre><o:p>&nbsp;</o:p></pre>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:7.5pt;font-family:"MS Sans Serif";mso-bidi-font-family:"Courier New"'>©
2004 Microsoft Corporation</span><span style='font-size:10.0pt;font-family:
Verdana;mso-bidi-font-family:"Courier New"'> <o:p></o:p></span></p>

<pre><o:p>&nbsp;</o:p></pre></div>

</body>

</html>

